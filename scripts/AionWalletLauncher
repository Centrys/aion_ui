#!/bin/bash -il

JAVA_VERSION=11.0.1
STORAGE_DIR=${HOME}/.aion
LOG_DIR=${STORAGE_DIR}/log
JAVA_INSTALL=${STORAGE_DIR}/java
JAVA_CMD=${JAVA_INSTALL}/bin/java

mkdir -p ${LOG_DIR}
CURRENT_DATE=`date '+%Y-%m-%d_%H:%M:%S'`

LOG_FILE=${LOG_DIR}/log_${CURRENT_DATE}

# get the directory of the currently executing script
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done

SCRIPT_PATH="$( cd -P "$( dirname "$SOURCE" )" >/dev/null && pwd )"
echo "Located script directory: ${SCRIPT_PATH}" 2>&1 >> ${LOG_FILE}
cd ${SCRIPT_PATH}


if [ ! -f ${JAVA_CMD} ] || [ $(${JAVA_CMD} -version 2>&1 | grep "${JAVA_VERSION}" | wc -l) -lt 1 ]; then
  echo "Could not find Java Install directory. Creating it now ..." 2>&1 >> ${LOG_FILE}
  mkdir -p ${JAVA_INSTALL}
  echo "Unzipping packaged JRE ..." 2>&1 >> ${LOG_FILE}
  unzip java.zip -d ${STORAGE_DIR} 2>&1 >> ${LOG_FILE}
fi

LEDGER=${SCRIPT_PATH}/native/mac/ledger
HID=${LEDGER}/hid
PATH=$PATH:${HID}/node-v8.11.4-darwin-x64/bin
if [ ! -d ${HID} ]; then
  echo "HID driver not installed. Installing it now ..." 2>&1 >> ${LOG_FILE}

  pushd ${LEDGER}
  echo "Entered the ledger directory $(pwd)" 2>&1 >> ${LOG_FILE}

  echo "Extracting the HID driver ..." 2>&1 >> ${LOG_FILE}
  tar -xzf hid.tar.gz 2>&1 >> ${LOG_FILE}

  pushd ${HID}
  echo "Entered the hid dirver directory $(pwd)" 2>&1 >> ${LOG_FILE}

  echo "Installing npm dependencies" 2>&1 >> ${LOG_FILE}
  npm install 2>&1 >> ${LOG_FILE}
  npm i -g npm 2>&1 >> ${LOG_FILE}
  npm rebuild usb_bindings --update-binary 2>&1 >> ${LOG_FILE}
  echo "In the driver directory $(pwd)" 2>&1 >> ${LOG_FILE}
  pwd
  popd
  popd
  echo "Back in the binary directory $(pwd)" 2>&1 >> ${LOG_FILE}

  open -a AionWallet
else
  # run the program
  LIB_DIR=$(cd ../Java && pwd)/*
  ${JAVA_CMD} -cp "${LIB_DIR}" -Dlocal.storage.dir=${STORAGE_DIR} -Xms300m -Xmx500m org.aion.wallet.WalletApplication 2>&1 >> ${LOG_FILE}
fi
